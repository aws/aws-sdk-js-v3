import {
    Credentials,
    Decoder,
    Encoder,
    Middleware,
    Handler,
    HandlerArguments,
    HandlerExecutionContext,
    HashConstructor,
    HttpEndpoint,
    Provider,
    QueryParameterBag
} from '@aws-sdk/types';
import {formatUrl} from '@aws-sdk/util-format-url';
import {presignRequestQuery} from '@aws-sdk/query-request-presigner';
import {QuerySerializer} from "@aws-sdk/protocol-query";
import {QueryBuilder} from '@aws-sdk/query-builder';

const regARN = /arn:[\w+=/,.@-]+:[\w+=/,.@-]+:([\w+=/,.@-]*)?:[0-9]+:[\w+=/,.@-]+(:[\w+=/,.@-]+)?(:[\w+=/,.@-]+)?/;

export type RDSInput = {[index: string]: any};

export function buildCrossRegionPresignedUrl<
    Input extends RDSInput,
    Output extends object  
>({
    sourceIdentifierKey,
    region: regionProvider,
    credentials: credentialsProvider,
    endpoint: endpointProvider,
    base64Encoder,
    utf8Decoder,
    sha256,
}: BuildRDSPresignedUrlParameters): Middleware<Input, Output> {
    return (
        next: Handler<Input, Output>,
        {model}: HandlerExecutionContext
    ): Handler<Input, Output> => async (
        args: HandlerArguments<Input>
    ): Promise<Output> => {
        //shallow copy of originalInput object
        const input = {...args.input as RDSInput};
        const region = await regionProvider();
        const sourceIdentifier = input[sourceIdentifierKey];
        if (
            !input.PresignedUrl && 
            isARN(sourceIdentifier) && 
            region !== getEndpointFromARN(sourceIdentifier)
        ) {
            const sourceRegion = getEndpointFromARN(sourceIdentifier);
            const resolvedEndpoint = await endpointProvider();
            const requestSerializer = new QuerySerializer(
                resolvedEndpoint, 
                new QueryBuilder(base64Encoder, utf8Decoder),
            );
            let request = requestSerializer.serialize(model, input);
            //DestinationRegion is not present in model
            request.query = request.query || {} as QueryParameterBag
            request.query['DestinationRegion'] = region;
            const presignedRequest = await presignRequestQuery(request, {
                //FIXME: need an endpoint provider for given region
                endpoint: {
                    ...resolvedEndpoint,
                    hostname: `rds.${sourceRegion}.amazonaws.com`,
                },
                credentials: await credentialsProvider(),
                sha256,
                signingName: 'rds',
                signingRegion: sourceRegion,
            })
            input.PreSignedUrl = formatUrl(presignedRequest);
        }
        return next({...args, input: input as Input});
    }
}

function isARN(id: string|undefined): boolean {
    if (!id) return false;
    return regARN.test(id);
}

function getEndpointFromARN(arn: string): string {
    const arnArr = arn.split(':');
    if(arnArr.length < 4) {
        throw new Error(`Cannot infer endpoint from '${arn}'`);
    }
    return arnArr[3];
}

/**
 * Config of the middleware to automatically add presigned URL to request.
 * The presigned URL is generated by sigV4 
 */
export interface BuildRDSPresignedUrlParameters {
    /**
     * A special input parameter that can either be a name or ARN.
     * The middleware will determine whether to generate presigned URL
     * according to this parameter.
     */
    sourceIdentifierKey: string,
    /**
     * Region provider used to sign the presigned URL
     */
    region: Provider<string>,
    /**
     * Credentials provider used to sign the presigned URL
     */
    credentials: Provider<Credentials>,
    /**
     * Endpoint provider of the original request.
     */
    endpoint: Provider<HttpEndpoint>,
    /**
     * Encoder to encode the blob input when generate presigned URL
     */
    base64Encoder: Encoder,
    /**
     * Decoder to decode input string when generate presigned URL
     */
    utf8Decoder: Decoder,
    /**
     * Hashing class used by signer
     */
    sha256: HashConstructor,
}
