import { 
    HashConstructor,
    HttpRequest,
    HttpEndpoint,
    Encoder,
    Decoder,
    Credentials,
    QueryParameterBag,
    DateInput,
 } from '@aws-sdk/types';
import { QuerySerializer } from '@aws-sdk/protocol-query';
import { QueryBuilder } from '@aws-sdk/query-builder';
import { SignatureV4 } from '@aws-sdk/signature-v4';
import { parseQueryString } from '@aws-sdk/querystring-parser';

/**
 * A wrapper function for SignatureV4.presignRequest. Used to 
 * generate presigned url at client side for query protocol 
 * services like RDS and EC2
 * @param request   Request generated by query serializer
 * @param option    Parameters used for adjusting the request
 *                  and signing
 */
export const presignRequestQuery = async (
    request: HttpRequest,
    {
        credentials,
        sha256,
        signingName,
        signingRegion,
        endpoint = <HttpEndpoint>request,
        expireTime = 60 * 60,
    }: PresignOption
): Promise<HttpRequest> => {
    request = {
        ...request,
        ...endpoint,
        method: 'GET',
        query: appendBodyToQuery(
            request.query,
            request.body as string
        ),
        headers: {}, //content-type will be ignored in presigned url
        body: undefined
    };
    const signer = new SignatureV4({
        credentials,
        region: signingRegion,
        service: signingName,
        sha256
    })
    return await signer.presignRequest(
        request,
        expirationTime(expireTime),
    );

}

function appendBodyToQuery(query: QueryParameterBag = {}, body?: string): QueryParameterBag | undefined {
    if (!body) return query;
    const bodyQuery = parseQueryString(body);
    for (const name in bodyQuery) {
        if (!(name in query)) {
            query[name] = bodyQuery[name];
        }
    }
    return query;
}

function expirationTime(durationSeconds: number): DateInput {
    return Math.round(((new Date()).valueOf() + durationSeconds * 1000) / 1000);
}

/**
 * Parameters used for adjusting the request and signing
 */
export interface PresignOption {
    /**
     * credentials used to sign the request.
     */
    credentials: Credentials;

    sha256: HashConstructor;
    /**
     * The service name used to sign the request
     */
    signingName: string;
    /**
     * The region that signer used to sign. Usally the same as 
     * that in request hostname
     */
    signingRegion: string;
    /**
     * Use endpoint other than that in request
     * @default request the same endpoint as in the request
     */
    endpoint?: HttpEndpoint;
    /**
     * The time span in second that the presigned url lives
     * @default 3600
     */
    expireTime?: number;
}
